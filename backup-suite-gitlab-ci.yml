# GitLab CI/CD è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«
# backup-suite ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç”¨ï¼ˆæœ¬ç•ªé…å¸ƒå¯¾å¿œï¼‰

# CI/CDå¤‰æ•°
variables:
  # Cargoè¨­å®š
  CARGO_HOME: $CI_PROJECT_DIR/.cargo
  CARGO_TARGET_DIR: $CI_PROJECT_DIR/target

  # Package Registry URL
  CARGO_REGISTRY_URL: "sparse+$CI_API_V4_URL/projects/$CI_PROJECT_ID/packages/cargo/"

  # Rustã‚³ãƒ³ãƒ‘ã‚¤ãƒ©è¨­å®š
  RUSTFLAGS: "-Dwarnings"  # è­¦å‘Šã‚’ã‚¨ãƒ©ãƒ¼ã¨ã—ã¦æ‰±ã†

  # ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³å›ºæœ‰è¨­å®š
  BACKUP_SUITE_VERSION: $CI_COMMIT_TAG
  BACKUP_SUITE_BUILD_TIMESTAMP: $CI_PIPELINE_CREATED_AT

# ã‚­ãƒ£ãƒƒã‚·ãƒ¥è¨­å®šï¼ˆãƒ“ãƒ«ãƒ‰é«˜é€ŸåŒ–ï¼‰
cache:
  key:
    files:
      - Cargo.lock
  paths:
    - .cargo/
    - target/

# ãƒ“ãƒ«ãƒ‰ã‚¹ãƒ†ãƒ¼ã‚¸å®šç¾©
stages:
  - validate    # ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯
  - test        # ãƒ†ã‚¹ãƒˆãƒ»å“è³ªãƒã‚§ãƒƒã‚¯
  - build       # ãƒã‚¤ãƒŠãƒªãƒ“ãƒ«ãƒ‰
  - package     # ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒ³ã‚°
  - publish     # Package Registryå…¬é–‹
  - release     # ãƒªãƒªãƒ¼ã‚¹ä½œæˆ
  - deploy      # æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤

# ğŸ›¡ï¸ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ãƒ†ãƒ¼ã‚¸
security:vulnerability-scan:
  stage: validate
  image: rust:1.75
  before_script:
    - cargo install cargo-audit cargo-deny
  script:
    # è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³
    - cargo audit --json > vulnerability-report.json

    # ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ãƒ»ä¾å­˜é–¢ä¿‚ãƒã‚§ãƒƒã‚¯
    - cargo deny check

    # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç‰¹åŒ–ã®ã‚¯ãƒªãƒƒãƒ—
    - cargo clippy --all-targets --all-features -- -D clippy::all -D clippy::suspicious
  artifacts:
    reports:
      dependency_scanning: vulnerability-report.json
    expire_in: 1 week
  allow_failure: false

security:secrets-detection:
  stage: validate
  image: alpine:latest
  before_script:
    - apk add --no-cache git grep
  script:
    # æ©Ÿå¯†æƒ…å ±ã®æ¤œå‡º
    - |
      echo "Scanning for secrets..."
      if grep -r -E "(password|secret|key|token)" --include="*.rs" --include="*.toml" .; then
        echo "âš ï¸ Potential secrets detected in source code"
        exit 1
      fi
    - echo "âœ… No secrets detected"
  only:
    - main
    - tags

# ğŸ§ª ãƒ†ã‚¹ãƒˆãƒ»å“è³ªãƒã‚§ãƒƒã‚¯ã‚¹ãƒ†ãƒ¼ã‚¸
test:unit-tests:
  stage: test
  image: rust:1.75
  before_script:
    - rustc --version
    - cargo --version
  script:
    # å˜ä½“ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
    - cargo test --all-features --verbose

    # ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ©Ÿèƒ½ã®çµ±åˆãƒ†ã‚¹ãƒˆ
    - cargo test --test integration_backup -- --test-threads=1

    # å¾©å…ƒæ©Ÿèƒ½ã®çµ±åˆãƒ†ã‚¹ãƒˆ
    - cargo test --test integration_restore -- --test-threads=1
  artifacts:
    reports:
      junit: target/junit.xml
    expire_in: 1 week

test:performance-benchmark:
  stage: test
  image: rust:1.75
  script:
    # ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ
    - cargo bench --bench backup_performance
    - cargo bench --bench compression_benchmark
  artifacts:
    paths:
      - target/criterion/
    expire_in: 1 week
  only:
    - main
    - tags

test:code-coverage:
  stage: test
  image: rust:1.75
  before_script:
    - cargo install cargo-tarpaulin
  script:
    - cargo tarpaulin --out Xml --output-dir coverage/ --exclude-files "target/*"
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura.xml
  coverage: '/(\d+\.\d+)% coverage/'

# ğŸ”¨ ãƒ“ãƒ«ãƒ‰ã‚¹ãƒ†ãƒ¼ã‚¸ï¼ˆæœ¬ç•ªæœ€é©åŒ–ï¼‰
build:linux-x64-optimized:
  stage: build
  image: rust:1.75
  script:
    # æœ¬ç•ªç”¨æœ€é©åŒ–ãƒ“ãƒ«ãƒ‰
    - export RUSTFLAGS="-C target-cpu=native -C opt-level=3 -C lto=fat"
    - cargo build --release --target x86_64-unknown-linux-gnu

    # ãƒã‚¤ãƒŠãƒªã‚µã‚¤ã‚ºæœ€é©åŒ–
    - strip target/x86_64-unknown-linux-gnu/release/backup-suite
    - upx --ultra-brute target/x86_64-unknown-linux-gnu/release/backup-suite || true

    # ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆæº–å‚™
    - mkdir -p artifacts/linux-x64
    - cp target/x86_64-unknown-linux-gnu/release/backup-suite artifacts/linux-x64/

    # ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±åŸ‹ã‚è¾¼ã¿
    - echo "$CI_COMMIT_TAG" > artifacts/linux-x64/VERSION
    - echo "$CI_COMMIT_SHA" > artifacts/linux-x64/COMMIT_SHA
  artifacts:
    paths:
      - artifacts/linux-x64/
    expire_in: 2 hours
  only:
    - main
    - tags

build:linux-arm64:
  stage: build
  image: rust:1.75
  before_script:
    - rustup target add aarch64-unknown-linux-gnu
    - apt-get update && apt-get install -y gcc-aarch64-linux-gnu
    - export CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=aarch64-linux-gnu-gcc
  script:
    - cargo build --release --target aarch64-unknown-linux-gnu
    - mkdir -p artifacts/linux-arm64
    - cp target/aarch64-unknown-linux-gnu/release/backup-suite artifacts/linux-arm64/
    - echo "$CI_COMMIT_TAG" > artifacts/linux-arm64/VERSION
  artifacts:
    paths:
      - artifacts/linux-arm64/
    expire_in: 2 hours
  only:
    - main
    - tags

build:macos-universal:
  stage: build
  image: rust:1.75
  before_script:
    - rustup target add x86_64-apple-darwin aarch64-apple-darwin
  script:
    # Intel Mac
    - cargo build --release --target x86_64-apple-darwin
    - mkdir -p artifacts/macos-x64
    - cp target/x86_64-apple-darwin/release/backup-suite artifacts/macos-x64/

    # Apple Silicon Mac
    - cargo build --release --target aarch64-apple-darwin
    - mkdir -p artifacts/macos-arm64
    - cp target/aarch64-apple-darwin/release/backup-suite artifacts/macos-arm64/

    # ãƒ¦ãƒ‹ãƒãƒ¼ã‚µãƒ«ãƒã‚¤ãƒŠãƒªä½œæˆï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
    - mkdir -p artifacts/macos-universal
    - lipo -create \
        target/x86_64-apple-darwin/release/backup-suite \
        target/aarch64-apple-darwin/release/backup-suite \
        -output artifacts/macos-universal/backup-suite || cp artifacts/macos-x64/backup-suite artifacts/macos-universal/
  artifacts:
    paths:
      - artifacts/macos-x64/
      - artifacts/macos-arm64/
      - artifacts/macos-universal/
    expire_in: 2 hours
  only:
    - main
    - tags
  tags:
    - macos
  allow_failure: true

# ğŸ“¦ ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒ³ã‚°ã‚¹ãƒ†ãƒ¼ã‚¸
package:create-distributions:
  stage: package
  image: alpine:latest
  dependencies:
    - build:linux-x64-optimized
    - build:linux-arm64
    - build:macos-universal
  before_script:
    - apk add --no-cache tar gzip zip
  script:
    # Linux x64 ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸
    - tar -czf backup-suite-linux-x64.tar.gz -C artifacts/linux-x64 .
    - sha256sum backup-suite-linux-x64.tar.gz > backup-suite-linux-x64.tar.gz.sha256

    # Linux ARM64 ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸
    - tar -czf backup-suite-linux-arm64.tar.gz -C artifacts/linux-arm64 .
    - sha256sum backup-suite-linux-arm64.tar.gz > backup-suite-linux-arm64.tar.gz.sha256

    # macOS ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸
    - tar -czf backup-suite-macos-universal.tar.gz -C artifacts/macos-universal .
    - sha256sum backup-suite-macos-universal.tar.gz > backup-suite-macos-universal.tar.gz.sha256

    # ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆåŒ…å«ç‰ˆ
    - mkdir -p complete-package
    - cp backup-suite-*.tar.gz complete-package/
    - cp *.sha256 complete-package/
    - echo "#!/bin/bash" > complete-package/install.sh
    - cat install.sh >> complete-package/install.sh
    - chmod +x complete-package/install.sh
    - tar -czf backup-suite-complete-package.tar.gz -C complete-package .
  artifacts:
    paths:
      - backup-suite-*.tar.gz
      - backup-suite-*.sha256
      - complete-package/
    expire_in: 1 week
  only:
    - tags

# ğŸ“¦ Package Registryå…¬é–‹
publish:package-registry:
  stage: publish
  image: rust:1.75
  dependencies:
    - build:linux-x64-optimized
  before_script:
    # GitLab Cargo Indexè¨­å®š
    - mkdir -p $CARGO_HOME
    - echo "[registries.gitlab]" >> $CARGO_HOME/config.toml
    - echo "index = \"$CARGO_REGISTRY_URL\"" >> $CARGO_HOME/config.toml
    - echo "token = \"$CI_JOB_TOKEN\"" >> $CARGO_HOME/config.toml
  script:
    # ãƒ¬ã‚¸ã‚¹ãƒˆãƒªãƒ­ã‚°ã‚¤ãƒ³
    - cargo login --registry gitlab "$CI_JOB_TOKEN"

    # ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸å…¬é–‹
    - cargo publish --registry gitlab --allow-dirty

    # å…¬é–‹ç¢ºèª
    - sleep 30  # ãƒ¬ã‚¸ã‚¹ãƒˆãƒªåæ˜ å¾…ã¡
    - cargo search --registry gitlab backup-suite
  only:
    - tags
  when: manual
  environment:
    name: package-registry
    url: $CI_PROJECT_URL/-/packages

# ğŸš€ ãƒªãƒªãƒ¼ã‚¹ä½œæˆ
release:create-github-style-release:
  stage: release
  image: alpine:latest
  dependencies:
    - package:create-distributions
    - test:performance-benchmark
  before_script:
    - apk add --no-cache curl tar gzip jq
  script:
    # ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ¬ãƒãƒ¼ãƒˆå–å¾—
    - |
      if [ -d "target/criterion" ]; then
        PERF_SUMMARY=$(find target/criterion -name "*.json" | head -1)
        if [ -f "$PERF_SUMMARY" ]; then
          BACKUP_SPEED=$(jq -r '.mean.estimate' "$PERF_SUMMARY" || echo "N/A")
        else
          BACKUP_SPEED="N/A"
        fi
      else
        BACKUP_SPEED="N/A"
      fi

    # ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆç”Ÿæˆ
    - |
      cat > release_notes.md << EOF
      # ğŸ—‚ï¸ backup-suite v$CI_COMMIT_TAG

      ## âœ¨ ä¸»ãªæ©Ÿèƒ½
      - ğŸš€ é«˜é€Ÿãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ»å¾©å…ƒï¼ˆå¹³å‡é€Ÿåº¦: ${BACKUP_SPEED} MB/sï¼‰
      - ğŸ—œï¸ åŠ¹ç‡çš„ãªåœ§ç¸®ãƒ»é‡è¤‡æ’é™¤
      - ğŸ” AES-256æš—å·åŒ–å¯¾å¿œ
      - ğŸ“… æŸ”è»Ÿãªã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°
      - ğŸ”„ å¢—åˆ†ãƒ»å·®åˆ†ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—

      ## ğŸ“¦ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
      | ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ  | ãƒã‚¤ãƒŠãƒª | SHA256 |
      |----------------|---------|--------|
      | Linux x64 | [backup-suite-linux-x64.tar.gz](${CI_PROJECT_URL}/-/releases/${CI_COMMIT_TAG}/downloads/backup-suite-linux-x64.tar.gz) | [SHA256](${CI_PROJECT_URL}/-/releases/${CI_COMMIT_TAG}/downloads/backup-suite-linux-x64.tar.gz.sha256) |
      | Linux ARM64 | [backup-suite-linux-arm64.tar.gz](${CI_PROJECT_URL}/-/releases/${CI_COMMIT_TAG}/downloads/backup-suite-linux-arm64.tar.gz) | [SHA256](${CI_PROJECT_URL}/-/releases/${CI_COMMIT_TAG}/downloads/backup-suite-linux-arm64.tar.gz.sha256) |
      | macOS Universal | [backup-suite-macos-universal.tar.gz](${CI_PROJECT_URL}/-/releases/${CI_COMMIT_TAG}/downloads/backup-suite-macos-universal.tar.gz) | [SHA256](${CI_PROJECT_URL}/-/releases/${CI_COMMIT_TAG}/downloads/backup-suite-macos-universal.tar.gz.sha256) |

      ## ğŸš€ ã‚¯ã‚¤ãƒƒã‚¯ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      \`\`\`bash
      # è‡ªå‹•ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      curl -sSL $CI_PROJECT_URL/-/raw/main/install.sh | bash

      # Package Registryã‹ã‚‰
      cargo install backup-suite --registry company

      # è¨­å®šãƒ»ä½¿ç”¨é–‹å§‹
      backup-suite init --interactive
      \`\`\`

      ## ğŸ“Š ã“ã®ãƒªãƒªãƒ¼ã‚¹ã®æ”¹å–„ç‚¹
      - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Š
      - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–
      - ä¼æ¥­ç’°å¢ƒã§ã®ä½¿ç”¨æ€§æ”¹å–„
      EOF

    # GitLab Releaseã‚’ä½œæˆ
    - |
      curl --request POST \
        --header "PRIVATE-TOKEN: $CI_JOB_TOKEN" \
        --header "Content-Type: application/json" \
        --data "{
          \"name\": \"backup-suite v$CI_COMMIT_TAG\",
          \"tag_name\": \"$CI_COMMIT_TAG\",
          \"description\": \"$(cat release_notes.md | jq -Rs .)\",
          \"assets\": {
            \"links\": [
              {
                \"name\": \"Linux x64 Binary\",
                \"url\": \"$CI_PROJECT_URL/-/jobs/artifacts/$CI_COMMIT_TAG/raw/backup-suite-linux-x64.tar.gz?job=package:create-distributions\",
                \"link_type\": \"package\"
              },
              {
                \"name\": \"Complete Package (All Platforms)\",
                \"url\": \"$CI_PROJECT_URL/-/jobs/artifacts/$CI_COMMIT_TAG/raw/backup-suite-complete-package.tar.gz?job=package:create-distributions\",
                \"link_type\": \"package\"
              },
              {
                \"name\": \"Installation Guide\",
                \"url\": \"$CI_PROJECT_URL/-/blob/main/INSTALL.md\",
                \"link_type\": \"other\"
              }
            ]
          }
        }" \
        "$CI_API_V4_URL/projects/$CI_PROJECT_ID/releases"
  only:
    - tags
  environment:
    name: releases
    url: $CI_PROJECT_URL/-/releases

# ğŸš€ æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆç¤¾å†…é…å¸ƒã‚µãƒ¼ãƒãƒ¼ï¼‰
deploy:internal-distribution:
  stage: deploy
  image: alpine:latest
  dependencies:
    - package:create-distributions
  before_script:
    - apk add --no-cache rsync openssh-client
    - eval $(ssh-agent -s)
    - echo "$DEPLOY_SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - echo "$DEPLOY_SSH_KNOWN_HOSTS" >> ~/.ssh/known_hosts
  script:
    # ç¤¾å†…é…å¸ƒã‚µãƒ¼ãƒãƒ¼ã«åŒæœŸ
    - |
      rsync -avz --delete \
        backup-suite-*.tar.gz \
        *.sha256 \
        complete-package/ \
        $DEPLOY_USER@$DEPLOY_SERVER:/var/www/internal-tools/backup-suite/v$CI_COMMIT_TAG/

    # æœ€æ–°ç‰ˆãƒªãƒ³ã‚¯æ›´æ–°
    - |
      ssh $DEPLOY_USER@$DEPLOY_SERVER \
        "cd /var/www/internal-tools/backup-suite && rm -f latest && ln -s v$CI_COMMIT_TAG latest"
  only:
    - tags
  environment:
    name: internal-distribution
    url: "https://tools.company.com/backup-suite"
  when: manual

# ğŸ“Š ç›£æŸ»ãƒ»é€šçŸ¥
audit:deployment-notification:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache curl jq
  script:
    # Slack/Teamsé€šçŸ¥
    - |
      curl -X POST "$NOTIFICATION_WEBHOOK_URL" \
        -H "Content-Type: application/json" \
        -d "{
          \"text\": \"ğŸ‰ backup-suite v$CI_COMMIT_TAG ãƒªãƒªãƒ¼ã‚¹å®Œäº†\",
          \"attachments\": [{
            \"color\": \"good\",
            \"fields\": [
              {\"title\": \"ãƒãƒ¼ã‚¸ãƒ§ãƒ³\", \"value\": \"$CI_COMMIT_TAG\", \"short\": true},
              {\"title\": \"ãƒªãƒªãƒ¼ã‚¹ãƒšãƒ¼ã‚¸\", \"value\": \"$CI_PROJECT_URL/-/releases/$CI_COMMIT_TAG\", \"short\": false}
            ]
          }]
        }"

    # ç›£æŸ»ãƒ­ã‚°
    - echo "$(date): backup-suite v$CI_COMMIT_TAG deployed by $CI_COMMIT_AUTHOR" >> /var/log/deployments.log
  only:
    - tags
  dependencies: []
  allow_failure: true

# ğŸ·ï¸ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼åˆ¶å¾¡
workflow:
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/     # ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¿ã‚°
    - if: $CI_COMMIT_BRANCH == "main"              # ãƒ¡ã‚¤ãƒ³ãƒ–ãƒ©ãƒ³ãƒ
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"  # ãƒãƒ¼ã‚¸ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
    - if: $CI_COMMIT_BRANCH =~ /^release\/.*$/     # ãƒªãƒªãƒ¼ã‚¹ãƒ–ãƒ©ãƒ³ãƒ