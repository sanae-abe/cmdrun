name: CLI Testing Specialist (Automated)

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
  schedule:
    # Run daily at 00:00 UTC for comprehensive testing
    - cron: '0 0 * * *'

env:
  CARGO_TERM_COLOR: always

jobs:
  cli-automated-testing:
    name: Automated CLI Testing (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        include:
          - os: ubuntu-latest
            binary: target/release/cmdrun
          - os: macos-latest
            binary: target/release/cmdrun

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Build cmdrun (release)
        run: cargo build --release

      - name: Verify cmdrun binary
        run: |
          ${{ matrix.binary }} --version
          ${{ matrix.binary }} --help

      # ========== cli-testing-specialist installation ==========

      - name: Cache cli-testing-specialist
        id: cache-cli-testing-specialist
        uses: actions/cache@v3
        with:
          path: ~/.cargo/bin/cli-testing-specialist
          key: ${{ runner.os }}-cli-testing-specialist-v1.0.2

      - name: Install cli-testing-specialist
        if: steps.cache-cli-testing-specialist.outputs.cache-hit != 'true'
        run: |
          cargo install --git https://github.com/sanae-abe/cli-testing-specialist --rev 3411fd4f8b2cb4937cb1c62082e4f62cbf783274 cli-testing-specialist

      - name: Verify cli-testing-specialist installation
        run: cli-testing-specialist --version

      # ========== CLI Analysis Phase ==========

      - name: Analyze cmdrun CLI
        run: |
          cli-testing-specialist analyze \
            ${{ matrix.binary }} \
            --output cmdrun-analysis.json

      - name: Display analysis summary
        run: |
          echo "ðŸ“Š Analysis Results:"
          jq -r '.binary_name + " v" + .version' cmdrun-analysis.json || true
          jq -r '"Global Options: " + (.global_options | length | tostring)' cmdrun-analysis.json
          jq -r '"Subcommands: " + (.subcommands | length | tostring)' cmdrun-analysis.json

      - name: Upload analysis results
        uses: actions/upload-artifact@v4
        with:
          name: cli-analysis-${{ matrix.os }}
          path: cmdrun-analysis.json
          retention-days: 30

      # ========== Test Generation Phase ==========

      - name: Generate CLI tests (default categories)
        run: |
          # Generate tests excluding resource-intensive categories
          cli-testing-specialist generate \
            cmdrun-analysis.json \
            --output cli-tests \
            --categories all

      - name: List generated test files
        run: |
          echo "ðŸ“ Generated Test Files:"
          ls -lh cli-tests/

      - name: Upload generated tests
        uses: actions/upload-artifact@v4
        with:
          name: cli-tests-${{ matrix.os }}
          path: cli-tests/
          retention-days: 30

      # ========== Test Execution Phase ==========

      - name: Install BATS
        run: |
          if [ "$RUNNER_OS" == "Linux" ]; then
            sudo apt-get update
            sudo apt-get install -y bats
          elif [ "$RUNNER_OS" == "macOS" ]; then
            brew install bats-core
          fi

      - name: Verify BATS installation
        run: bats --version

      - name: Add cmdrun to PATH
        run: |
          mkdir -p "$HOME/.local/bin"
          ln -sf "$PWD/${{ matrix.binary }}" "$HOME/.local/bin/cmdrun"
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Verify cmdrun in PATH
        run: |
          which cmdrun
          cmdrun --version

      - name: Run CLI tests
        continue-on-error: true
        run: |
          cli-testing-specialist run \
            cli-tests \
            --format all \
            --output cli-reports \
            --timeout 60

      - name: Display test results summary
        if: always()
        run: |
          if [ -f cli-reports/cli-tests-report.json ]; then
            echo "ðŸ“Š Test Results:"
            TOTAL=$(jq '[.suites[].tests | length] | add' cli-reports/cli-tests-report.json)
            PASSED=$(jq '[.suites[].tests[] | select(.status == "passed")] | length' cli-reports/cli-tests-report.json)
            FAILED=$(jq '[.suites[].tests[] | select(.status == "failed")] | length' cli-reports/cli-tests-report.json)
            echo "Total: $TOTAL"
            echo "Passed: $PASSED"
            echo "Failed: $FAILED"
            if [ "$TOTAL" -gt 0 ]; then
              SUCCESS_RATE=$(echo "scale=1; $PASSED * 100 / $TOTAL" | bc)
              echo "Success Rate: ${SUCCESS_RATE}%"
            fi
          fi

      # ========== Report Upload ==========

      - name: Upload test reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: cli-test-reports-${{ matrix.os }}
          path: cli-reports/
          retention-days: 30

      - name: Upload JUnit XML for test reporting
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: junit-report-${{ matrix.os }}
          path: cli-reports/*-junit.xml
          retention-days: 30

      # ========== Test Results Check ==========

      - name: Check test results (informational)
        if: always()
        continue-on-error: true
        run: |
          echo "ðŸ“‹ CLI Testing Summary"
          echo "Note: Generic tests from cli-testing-specialist are for reference."
          echo "Tests may fail due to cmdrun's configuration-driven architecture (commands.toml required)."
          echo ""
          if [ -f cli-reports/cli-tests-report.md ]; then
            echo "Full report available in artifacts: cli-test-reports-${{ matrix.os }}"
          fi

  # Security-focused automated testing
  cli-security-automated:
    name: Automated Security Testing
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Build cmdrun
        run: cargo build --release

      - name: Cache cli-testing-specialist
        id: cache-cli-testing-specialist-security
        uses: actions/cache@v3
        with:
          path: ~/.cargo/bin/cli-testing-specialist
          key: ${{ runner.os }}-cli-testing-specialist-v1.0.2

      - name: Install cli-testing-specialist
        if: steps.cache-cli-testing-specialist-security.outputs.cache-hit != 'true'
        run: |
          cargo install --git https://github.com/sanae-abe/cli-testing-specialist --rev 3411fd4f8b2cb4937cb1c62082e4f62cbf783274 cli-testing-specialist

      - name: Analyze CLI
        run: |
          cli-testing-specialist analyze \
            target/release/cmdrun \
            --output cmdrun-analysis.json

      - name: Generate security tests only
        run: |
          cli-testing-specialist generate \
            cmdrun-analysis.json \
            --output security-tests \
            --categories security,input-validation

      - name: Install BATS
        run: sudo apt-get update && sudo apt-get install -y bats

      - name: Run security tests
        continue-on-error: true
        run: |
          cli-testing-specialist run \
            security-tests \
            --format all \
            --output security-reports

      - name: Upload security reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-test-reports
          path: security-reports/
          retention-days: 90

      - name: Check for security failures (informational)
        if: always()
        continue-on-error: true
        run: |
          echo "ðŸ“‹ Security Testing Summary"
          echo "Note: Generic security tests from cli-testing-specialist are for reference."
          echo "Tests may fail due to cmdrun's custom implementation."
          echo ""
          if [ -f security-reports/security-tests-report.md ]; then
            echo "Full security report available in artifacts: security-test-reports"
          fi
