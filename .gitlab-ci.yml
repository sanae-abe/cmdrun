# GitLab CI/CD è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«
# cmdrun ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç”¨

# CI/CDå¤‰æ•°
variables:
  # Cargoè¨­å®š
  CARGO_HOME: $CI_PROJECT_DIR/.cargo
  CARGO_TARGET_DIR: $CI_PROJECT_DIR/target

  # Package Registry URL
  CARGO_REGISTRY_URL: "sparse+$CI_API_V4_URL/projects/$CI_PROJECT_ID/packages/cargo/"

  # Rustã‚³ãƒ³ãƒ‘ã‚¤ãƒ©è¨­å®š
  RUSTFLAGS: "-Dwarnings"  # è­¦å‘Šã‚’ã‚¨ãƒ©ãƒ¼ã¨ã—ã¦æ‰±ã†

# ã‚­ãƒ£ãƒƒã‚·ãƒ¥è¨­å®šï¼ˆãƒ“ãƒ«ãƒ‰é«˜é€ŸåŒ–ï¼‰
cache:
  key: "$CI_COMMIT_REF_SLUG"
  paths:
    - .cargo/
    - target/

# ãƒ“ãƒ«ãƒ‰ã‚¹ãƒ†ãƒ¼ã‚¸å®šç¾©
stages:
  - test      # ãƒ†ã‚¹ãƒˆãƒ»å“è³ªãƒã‚§ãƒƒã‚¯
  - build     # ãƒã‚¤ãƒŠãƒªãƒ“ãƒ«ãƒ‰
  - publish   # Package Registryå…¬é–‹
  - release   # ãƒªãƒªãƒ¼ã‚¹ä½œæˆ

# ğŸ§ª ãƒ†ã‚¹ãƒˆãƒ»å“è³ªãƒã‚§ãƒƒã‚¯ã‚¹ãƒ†ãƒ¼ã‚¸
test:cargo-test:
  stage: test
  image: rust:latest
  before_script:
    - rustc --version
    - cargo --version
    - cargo clean  # ã‚­ãƒ£ãƒƒã‚·ãƒ¥å•é¡Œå›é¿ã®ãŸã‚ã‚¯ãƒªãƒ¼ãƒ³ãƒ“ãƒ«ãƒ‰
  script:
    - cargo test --all-features --verbose
  artifacts:
    reports:
      junit: target/junit.xml
    expire_in: 1 week

test:security-audit:
  stage: test
  image: rust:latest
  before_script:
    - cargo install cargo-audit
    - rustup component add clippy
  script:
    - cargo audit --json > audit-report.json || true
    - cargo clippy --all-targets --all-features -- -D warnings
  artifacts:
    reports:
      dependency_scanning: audit-report.json
    expire_in: 1 week
  allow_failure: false

test:format-check:
  stage: test
  image: rust:latest
  script:
    - rustup component add rustfmt
    - cargo fmt -- --check

# ğŸ”¨ ãƒ“ãƒ«ãƒ‰ã‚¹ãƒ†ãƒ¼ã‚¸
build:linux-x64:
  stage: build
  image: rust:latest
  script:
    - cargo build --release --target x86_64-unknown-linux-gnu
    - strip target/x86_64-unknown-linux-gnu/release/cmdrun
    - mkdir -p artifacts/linux-x64
    - cp target/x86_64-unknown-linux-gnu/release/cmdrun artifacts/linux-x64/
    - tar -czf cmdrun-linux-x64.tar.gz -C artifacts/linux-x64 cmdrun
  artifacts:
    paths:
      - cmdrun-linux-x64.tar.gz
      - artifacts/linux-x64/cmdrun
    expire_in: 1 hour
  only:
    - main
    - tags

build:linux-arm64:
  stage: build
  image: rust:latest
  before_script:
    - rustup target add aarch64-unknown-linux-gnu
    - apt-get update && apt-get install -y gcc-aarch64-linux-gnu
    - export CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=aarch64-linux-gnu-gcc
  script:
    - cargo build --release --target aarch64-unknown-linux-gnu
    - mkdir -p artifacts/linux-arm64
    - cp target/aarch64-unknown-linux-gnu/release/cmdrun artifacts/linux-arm64/
    - tar -czf cmdrun-linux-arm64.tar.gz -C artifacts/linux-arm64 cmdrun
  artifacts:
    paths:
      - cmdrun-linux-arm64.tar.gz
      - artifacts/linux-arm64/cmdrun
    expire_in: 1 hour
  only:
    - main
    - tags

build:macos-x64:
  stage: build
  image: rust:latest
  before_script:
    - rustup target add x86_64-apple-darwin
    # macOSã‚¯ãƒ­ã‚¹ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«è¨­å®šï¼ˆä¼æ¥­ç’°å¢ƒã§ã¯è¦èª¿æ•´ï¼‰
  script:
    - cargo build --release --target x86_64-apple-darwin
    - mkdir -p artifacts/macos-x64
    - cp target/x86_64-apple-darwin/release/cmdrun artifacts/macos-x64/
    - tar -czf cmdrun-macos-x64.tar.gz -C artifacts/macos-x64 cmdrun
  artifacts:
    paths:
      - cmdrun-macos-x64.tar.gz
      - artifacts/macos-x64/cmdrun
    expire_in: 1 hour
  only:
    - main
    - tags
  tags:
    - macos  # macOSå°‚ç”¨ãƒ©ãƒ³ãƒŠãƒ¼ãŒå¿…è¦
  allow_failure: true  # macOSãƒ©ãƒ³ãƒŠãƒ¼ãŒãªã„å ´åˆã¯å¤±æ•—ã‚’è¨±å¯
  when: manual  # æ‰‹å‹•å®Ÿè¡Œã®ã¿ï¼ˆmacOSãƒ©ãƒ³ãƒŠãƒ¼ãŒåˆ©ç”¨å¯èƒ½ãªå ´åˆã«å®Ÿè¡Œï¼‰
  timeout: 30m  # ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’30åˆ†ã«è¨­å®šï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ1æ™‚é–“ï¼‰

# ğŸ“¦ Package Registryå…¬é–‹
publish:package-registry:
  stage: publish
  image: rust:latest
  dependencies:
    - build:linux-x64
  before_script:
    # GitLab Cargo Indexè¨­å®š
    - mkdir -p $CARGO_HOME
    - echo "[registries.gitlab]" >> $CARGO_HOME/config.toml
    - echo "index = \"$CARGO_REGISTRY_URL\"" >> $CARGO_HOME/config.toml
    - echo "token = \"$CI_JOB_TOKEN\"" >> $CARGO_HOME/config.toml
  script:
    # ãƒ¬ã‚¸ã‚¹ãƒˆãƒªãƒ­ã‚°ã‚¤ãƒ³
    - cargo login --registry gitlab "$CI_JOB_TOKEN"

    # ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸å…¬é–‹
    - cargo publish --registry gitlab --allow-dirty
  only:
    - tags     # ã‚¿ã‚°ä»˜ãã‚³ãƒŸãƒƒãƒˆã®ã¿
    - main     # ãƒ¡ã‚¤ãƒ³ãƒ–ãƒ©ãƒ³ãƒï¼ˆé–‹ç™ºç‰ˆï¼‰
  when: manual # æ‰‹å‹•å®Ÿè¡Œã§å®‰å…¨æ€§ç¢ºä¿

# ğŸš€ ãƒªãƒªãƒ¼ã‚¹ä½œæˆ
release:create-release:
  stage: release
  image: alpine:latest
  dependencies:
    - build:linux-x64
    - build:linux-arm64
    - build:macos-x64
  before_script:
    - apk add --no-cache curl tar gzip jq
  script:
    # ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆç”Ÿæˆ
    - |
      cat > release_notes.md << EOF
      # cmdrun v$CI_COMMIT_TAG

      ## æ–°æ©Ÿèƒ½ãƒ»æ”¹å–„
      - é«˜é€Ÿãªã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ
      - TOMLè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«å¯¾å¿œ
      - ä¾å­˜é–¢ä¿‚ã‚°ãƒ©ãƒ•è¡¨ç¤º

      ## ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
      - Linux x64: [cmdrun-linux-x64.tar.gz](${CI_PROJECT_URL}/-/releases/${CI_COMMIT_TAG}/downloads/cmdrun-linux-x64.tar.gz)
      - Linux ARM64: [cmdrun-linux-arm64.tar.gz](${CI_PROJECT_URL}/-/releases/${CI_COMMIT_TAG}/downloads/cmdrun-linux-arm64.tar.gz)
      - macOS x64: [cmdrun-macos-x64.tar.gz](${CI_PROJECT_URL}/-/releases/${CI_COMMIT_TAG}/downloads/cmdrun-macos-x64.tar.gz)

      ## ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•
      \`\`\`bash
      # è‡ªå‹•ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      curl -sSL $CI_PROJECT_URL/-/raw/main/install.sh | bash

      # Package Registryã‹ã‚‰
      cargo install cmdrun --registry company
      \`\`\`
      EOF

    # GitLab Releaseã‚’ä½œæˆ
    - |
      curl --request POST \
        --header "PRIVATE-TOKEN: $CI_JOB_TOKEN" \
        --header "Content-Type: application/json" \
        --data "{
          \"name\": \"cmdrun v$CI_COMMIT_TAG\",
          \"tag_name\": \"$CI_COMMIT_TAG\",
          \"description\": \"$(cat release_notes.md | jq -Rs .)\",
          \"assets\": {
            \"links\": [
              {
                \"name\": \"Linux x64 Binary\",
                \"url\": \"$CI_PROJECT_URL/-/jobs/artifacts/$CI_COMMIT_TAG/raw/cmdrun-linux-x64.tar.gz?job=build:linux-x64\"
              },
              {
                \"name\": \"Linux ARM64 Binary\",
                \"url\": \"$CI_PROJECT_URL/-/jobs/artifacts/$CI_COMMIT_TAG/raw/cmdrun-linux-arm64.tar.gz?job=build:linux-arm64\"
              },
              {
                \"name\": \"macOS x64 Binary\",
                \"url\": \"$CI_PROJECT_URL/-/jobs/artifacts/$CI_COMMIT_TAG/raw/cmdrun-macos-x64.tar.gz?job=build:macos-x64\"
              }
            ]
          }
        }" \
        "$CI_API_V4_URL/projects/$CI_PROJECT_ID/releases"
  only:
    - tags
  when: manual

# ğŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ»ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹
security:dependency-scanning:
  stage: test
  image: rust:latest
  before_script:
    - cargo install cargo-audit
  script:
    - cargo audit --json > audit-report.json || true
  artifacts:
    reports:
      dependency_scanning: audit-report.json
  only:
    - main
    - merge_requests

# ğŸ“Š ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãƒ»åˆ†æ
metrics:code-coverage:
  stage: test
  image: rust:latest
  before_script:
    - cargo install cargo-tarpaulin
  script:
    - cargo tarpaulin --out Xml --output-dir coverage/
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura.xml
  coverage: '/(\d+\.\d+)% coverage/'
  only:
    - main
    - merge_requests

# ğŸ·ï¸ ã‚¿ã‚°ã”ã¨ã®è‡ªå‹•å®Ÿè¡Œè¨­å®š
workflow:
  rules:
    - if: $CI_COMMIT_TAG         # ã‚¿ã‚°ä»˜ãã‚³ãƒŸãƒƒãƒˆ
    - if: $CI_COMMIT_BRANCH == "main"  # ãƒ¡ã‚¤ãƒ³ãƒ–ãƒ©ãƒ³ãƒ
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"  # MR